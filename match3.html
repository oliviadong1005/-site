<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>张沛林 - 进阶消消乐</title>
<style>
  body{margin:0;font-family:"Noto Sans SC",sans-serif;background:#0f1724;color:#e6f0f2;text-align:center}
  h1{margin:.3em 0;font-size:1.6rem}
  #info{display:flex;justify-content:space-around;max-width:420px;margin:.5em auto;font-size:1.1rem}
  #gameBoard{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;max-width:420px;margin:0 auto;padding:0 10px}
  .tile{aspect-ratio:1/1;border-radius:8px;cursor:pointer;background-size:cover;background-position:center}
  .tile.selected{outline:3px solid #fff}
  #endMask{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;flex-direction:column;align-items:center;justify-content:center;font-size:1.5rem}
  .back{margin-top:1.2em;font-size:1.1rem;color:#6ee7b7;text-decoration:none}
</style>
</head>
<body>
  <h1>进阶消消乐</h1>
  <div id="info">
    <span>得分：<span id="score">0</span></span>
    <span>剩余步数：<span id="moves">20</span></span>
  </div>
  <div id="gameBoard"></div>
  <a class="back" href="./">← 返回主页</a>

  <!-- 结束面板 -->
  <div id="endMask">
    <div id="msg">游戏结束！得分：<span id="finalScore">0</span></div>
    <a class="back" href="javascript:location.reload()">再来一局</a>
  </div>

<script>
/* ---------- 配置 ---------- */
const ROW = 6, COL = 6, IMGS = 6;          // 6 种方块
const folder = 'https://zplapi.github.io/zplapi-site/img/'; // 绝对路径
let board = [], score = 0, movesLeft = 20;

const $ = s => document.querySelector(s);
const boardEl = $('#gameBoard');
const scoreEl = $('#score');
const movesEl = $('#moves');
const endMask = $('#endMask');
const finalScoreEl = $('#finalScore');

/* ---------- 工具 ---------- */
const rand = () => Math.floor(Math.random() * IMGS);
function initBoard() {
  board = Array.from({length: ROW}, () => Array.from({length: COL}, rand));
  draw();
}
function draw() {
  boardEl.innerHTML = '';
  board.forEach((r, i) => r.forEach((v, j) => {
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.r = i;
    tile.dataset.c = j;
    tile.style.backgroundImage = `url(${folder}${v}.jpg)`;
    tile.addEventListener('click', onClick);
    boardEl.appendChild(tile);
  }));
}

/* ---------- 消除算法 ---------- */
function markMatches() {
  const toClear = new Set();
  // 横向
  for (let r = 0; r < ROW; r++) {
    for (let c = 0; c < COL; ) {
      const v = board[r][c];
      let len = 1;
      while (c + len < COL && board[r][c + len] === v) len++;
      if (len >= 3) {
        for (let i = 0; i < len; i++) toClear.add(`${r},${c + i}`);
        score += len === 3 ? 10 : len === 4 ? 15 : 20;
      }
      c += len;
    }
  }
  // 纵向
  for (let c = 0; c < COL; c++) {
    for (let r = 0; r < ROW; ) {
      const v = board[r][c];
      let len = 1;
      while (r + len < ROW && board[r + len][c] === v) len++;
      if (len >= 3) {
        for (let i = 0; i < len; i++) toClear.add(`${r + i},${c}`);
        score += len === 3 ? 10 : len === 4 ? 15 : 20;
      }
      r += len;
    }
  }
  toClear.forEach(pos => {
    const [r, c] = pos.split(',').map(Number);
    board[r][c] = -1;
  });
  return toClear.size > 0;
}

function dropDown() {
  for (let c = 0; c < COL; c++) {
    const col = [];
    for (let r = ROW - 1; r >= 0; r--) if (board[r][c] !== -1) col.push(board[r][c]);
    while (col.length < ROW) col.push(rand());
    for (let r = 0; r < ROW; r++) board[r][c] = col[ROW - 1 - r];
  }
}

async function cascade() {
  while (markMatches()) {
    await new Promise(r => setTimeout(r, 200));
    dropDown();
    draw();
  }
  scoreEl.textContent = score;
  if (movesLeft === 0) endGame();
}

/* ---------- 用户交互 ---------- */
let sel = null;
function onClick(e) {
  if (movesLeft === 0) return;
  const tile = e.target, r = +tile.dataset.r, c = +tile.dataset.c;
  if (!sel) {
    sel = [r, c];
    tile.classList.add('selected');
  } else {
    const [sr, sc] = sel;
    tile.classList.remove('selected');
    if (Math.abs(sr - r) + Math.abs(sc - c) === 1) {
      [board[sr][sc], board[r][c]] = [board[r][c], board[sr][sc]];
      draw();
      sel = null;
      movesLeft--;
      movesEl.textContent = movesLeft;
      cascade();
    } else {
      sel = [r, c];
      tile.classList.add('selected');
    }
  }
}

function endGame() {
  finalScoreEl.textContent = score;
  endMask.style.display = 'flex';
}

/* ---------- 启动 ---------- */
initBoard();
scoreEl.textContent = score;
movesEl.textContent = movesLeft;
</script>
</body>
</html>
